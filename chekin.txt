# BRIEFING: Refatora√ß√£o Completa do Fluxo de Conclus√£o de Receitas

## CONTEXTO
Refatorar sistema de conclus√£o de receitas eliminando paralisia de decis√£o. Implementar gamifica√ß√£o progressiva onde a recompensa √© consequ√™ncia, n√£o obst√°culo.

## PROBLEMA ATUAL
1. Usu√°rio enfrenta dupla decis√£o simult√¢nea (conclus√£o r√°pida vs completa)
2. Pontua√ß√£o exposta prematuramente cria fric√ß√£o
3. Dois fluxos competindo em vez de progress√£o natural

## SOLU√á√ÉO: FLUXO PROGRESSIVO EM 3 ETAPAS

---

## ETAPA 1: A√á√ÉO PRIM√ÅRIA (Durante a Receita)

### Comportamento
- Bot√£o √∫nico, proeminente
- SEM men√ß√£o a pontos
- Label: "Finalizar Receita"
- Ao clicar: marca receita como conclu√≠da + navega para Etapa 2

### Specs de Design
- Bot√£o fixo na parte inferior
- Estilo: Primary CTA (tema magenta/pink)
- Sem informa√ß√µes secund√°rias

### TypeScript Interface
```typescript
// components/RecipeCompletionButton.tsx
interface RecipeCompletionButtonProps {
  recipeId: string;
  onComplete: () => void;
}
```

---

## ETAPA 2: CONFIRMA√á√ÉO E MICRO-VIT√ìRIA

### Comportamento
- Exibir AP√ìS salvar conclus√£o no DB
- Anima√ß√£o de celebra√ß√£o (confetti/sucesso)
- Adicionar 5 pontos ao usu√°rio ANTES de exibir tela
- Dura√ß√£o m√≠nima: 1.5s (refor√ßo emocional)
- N√£o permite voltar (prevenir duplicatas)

### Elementos Visuais
```
üéâ Receita conclu√≠da!
Voc√™ ganhou 5 pontos

[Bot√£o: Continuar]
```

### TypeScript Interface
```typescript
// screens/RecipeCompletionConfirmation.tsx
interface CompletionConfirmationProps {
  recipeId: string;
  basePoints: 5;
  completedAt: Date;
  onContinue: () => void;
}
```

---

## ETAPA 3: ENGAJAMENTO PROGRESSIVO (Opcional)

### Layout da Tela

#### HEADER
```
üíé Quer ganhar mais pontos?
Leva menos de 1 minuto

[Barra de Progresso Visual]
‚ñ†‚ñ†‚ñ°‚ñ°‚ñ° 10 / 30 pontos
```

#### SE√á√ÉO 1: AVALIA√á√ÉO (Auto-expandida)
```
‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
O que achou da receita?

üíé +10 pontos
```

**Comportamento:**
- Se√ß√£o aberta por padr√£o
- 5 estrelas pr√©-selecionadas
- Ao clicar em qualquer estrela: registra imediatamente
- Adiciona 10 pontos ao mudar avalia√ß√£o

#### SE√á√ÉO 2: FOTO (Colapsada)
```
üì∑ Adicionar foto
Mostre como ficou!

üíé +10 pontos
```

**Comportamento:**
- Abre c√¢mera/galeria
- Preview antes de confirmar
- Upload ass√≠ncrono (n√£o bloqueia conclus√£o)

#### SE√á√ÉO 3: COMENT√ÅRIO (Colapsada)
```
[Input multiline]
Placeholder: "Alguma dica, modifica√ß√£o ou resultado?"

[Contador de caracteres: 0/20]
üíé +10 pontos
```

**Comportamento:**
- Valida√ß√£o em tempo real
- Barra de progresso de caracteres
- Pontos adicionados apenas ao atingir 20 caracteres

#### CTA DIN√ÇMICO (Rodap√© fixo)
```
L√≥gica do label:
- 0 pontos ganhos: "Concluir"
- 10+ pontos ganhos: "Concluir (+10 pontos)"
- 20+ pontos ganhos: "Concluir (+20 pontos)"
- 30 pontos ganhos: "Concluir (+30 pontos)"
```

**Comportamento:**
- Sempre habilitado (nunca disabled)
- Salva todos os dados preenchidos
- Adiciona pontos pendentes ao total do usu√°rio
- Navega para home/feed

---

## ESTRUTURA DE DADOS

### Schema SQL
```sql
CREATE TABLE recipe_completions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) NOT NULL,
  recipe_id UUID REFERENCES recipes(id) NOT NULL,
  completed_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- Dados de engajamento (nullable)
  rating INTEGER CHECK (rating >= 1 AND rating <= 5),
  photo_url TEXT,
  comment TEXT,
  comment_length INTEGER,
  
  -- Pontos concedidos
  base_points INTEGER DEFAULT 5,
  rating_points INTEGER DEFAULT 0,
  photo_points INTEGER DEFAULT 0,
  comment_points INTEGER DEFAULT 0,
  total_points INTEGER GENERATED ALWAYS AS 
    (base_points + rating_points + photo_points + comment_points) STORED,
  
  -- Metadados
  engagement_completed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(user_id, recipe_id)
);

-- √çndices
CREATE INDEX idx_recipe_completions_user ON recipe_completions(user_id);
CREATE INDEX idx_recipe_completions_recipe ON recipe_completions(recipe_id);
CREATE INDEX idx_recipe_completions_completed_at ON recipe_completions(completed_at);
```

### TypeScript Types
```typescript
// types/recipe-completion.ts

export interface RecipeCompletion {
  id: string;
  userId: string;
  recipeId: string;
  completedAt: Date;
  
  // Engajamento
  rating?: number;
  photoUrl?: string;
  comment?: string;
  commentLength?: number;
  
  // Pontua√ß√£o
  basePoints: number;
  ratingPoints: number;
  photoPoints: number;
  commentPoints: number;
  totalPoints: number;
  
  // Metadados
  engagementCompletedAt?: Date;
  createdAt: Date;
  updatedAt: Date;
}

export interface EngagementData {
  rating?: number;
  photoUri?: string;
  comment?: string;
}

export interface EngagementProgress {
  pointsEarned: number;
  maxPoints: 30;
  breakdown: {
    rating: { completed: boolean; points: 10 };
    photo: { completed: boolean; points: 10 };
    comment: { completed: boolean; points: 10 };
  };
}
```

---

## L√ìGICA DE BACKEND

### Service: Conclus√£o Inicial
```typescript
// services/recipe-completion.service.ts

import { supabase } from '@/lib/supabase';
import { RecipeCompletion } from '@/types/recipe-completion';

export async function completeRecipe(
  userId: string, 
  recipeId: string
): Promise<RecipeCompletion> {
  try {
    // 1. Criar registro de conclus√£o
    const { data: completion, error: completionError } = await supabase
      .from('recipe_completions')
      .insert({
        user_id: userId,
        recipe_id: recipeId,
        base_points: 5
      })
      .select()
      .single();

    if (completionError) throw completionError;

    // 2. Adicionar pontos ao usu√°rio
    const { error: pointsError } = await supabase.rpc('add_user_points', {
      user_id: userId,
      points: 5,
      source: 'recipe_completion',
      reference_id: completion.id
    });

    if (pointsError) throw pointsError;

    // 3. Registrar atividade no feed (se aplic√°vel)
    await createFeedActivity({
      userId,
      type: 'recipe_completed',
      recipeId,
      points: 5
    });

    return completion;
  } catch (error) {
    console.error('Erro ao completar receita:', error);
    throw error;
  }
}

// Helper para atividade no feed
async function createFeedActivity(params: {
  userId: string;
  type: string;
  recipeId: string;
  points: number;
}) {
  const { error } = await supabase
    .from('feed_activities')
    .insert({
      user_id: params.userId,
      activity_type: params.type,
      recipe_id: params.recipeId,
      points: params.points,
      created_at: new Date()
    });

  if (error) console.error('Erro ao criar atividade no feed:', error);
}
```

### Service: Atualiza√ß√£o de Engajamento
```typescript
// services/recipe-completion.service.ts

export async function updateEngagement(
  completionId: string,
  userId: string,
  data: Partial<EngagementData>
): Promise<number> {
  try {
    const updates: any = { updated_at: new Date() };
    let pointsToAdd = 0;

    // Buscar estado atual
    const { data: current } = await supabase
      .from('recipe_completions')
      .select('rating_points, photo_points, comment_points')
      .eq('id', completionId)
      .single();

    // Avaliar RATING
    if (data.rating !== undefined && current.rating_points === 0) {
      updates.rating = data.rating;
      updates.rating_points = 10;
      pointsToAdd += 10;
    }

    // Avaliar FOTO
    if (data.photoUri && current.photo_points === 0) {
      updates.photo_url = data.photoUri;
      updates.photo_points = 10;
      pointsToAdd += 10;
    }

    // Avaliar COMENT√ÅRIO
    if (data.comment && data.comment.length >= 20 && current.comment_points === 0) {
      updates.comment = data.comment;
      updates.comment_length = data.comment.length;
      updates.comment_points = 10;
      pointsToAdd += 10;
    }

    // Se h√° mudan√ßas, atualizar
    if (Object.keys(updates).length > 1) {
      updates.engagement_completed_at = new Date();

      const { error: updateError } = await supabase
        .from('recipe_completions')
        .update(updates)
        .eq('id', completionId);

      if (updateError) throw updateError;

      // Adicionar pontos ao usu√°rio
      if (pointsToAdd > 0) {
        const { error: pointsError } = await supabase.rpc('add_user_points', {
          user_id: userId,
          points: pointsToAdd,
          source: 'recipe_engagement',
          reference_id: completionId
        });

        if (pointsError) throw pointsError;
      }
    }

    return pointsToAdd;
  } catch (error) {
    console.error('Erro ao atualizar engajamento:', error);
    throw error;
  }
}
```

### Service: Buscar Progresso
```typescript
// services/recipe-completion.service.ts

export async function getEngagementProgress(
  completionId: string
): Promise<EngagementProgress> {
  const { data, error } = await supabase
    .from('recipe_completions')
    .select('rating_points, photo_points, comment_points')
    .eq('id', completionId)
    .single();

  if (error) throw error;

  const pointsEarned = 
    data.rating_points + 
    data.photo_points + 
    data.comment_points;

  return {
    pointsEarned,
    maxPoints: 30,
    breakdown: {
      rating: { 
        completed: data.rating_points > 0, 
        points: 10 
      },
      photo: { 
        completed: data.photo_points > 0, 
        points: 10 
      },
      comment: { 
        completed: data.comment_points > 0, 
        points: 10 
      }
    }
  };
}
```

---

## COMPONENTES REACT/REACT NATIVE

### Componente: Bot√£o de Conclus√£o (Etapa 1)
```typescript
// components/RecipeCompletionButton.tsx

import React from 'react';
import { TouchableOpacity, Text, StyleSheet } from 'react-native';

interface RecipeCompletionButtonProps {
  recipeId: string;
  onComplete: () => void;
  loading?: boolean;
}

export const RecipeCompletionButton: React.FC<RecipeCompletionButtonProps> = ({
  recipeId,
  onComplete,
  loading = false
}) => {
  return (
    <TouchableOpacity
      style={styles.button}
      onPress={onComplete}
      disabled={loading}
      activeOpacity={0.8}
    >
      <Text style={styles.buttonText}>
        {loading ? 'Finalizando...' : 'Finalizar Receita'}
      </Text>
    </TouchableOpacity>
  );
};

const styles = StyleSheet.create({
  button: {
    position: 'absolute',
    bottom: 24,
    left: 24,
    right: 24,
    backgroundColor: '#D946EF', // Magenta do tema
    paddingVertical: 16,
    borderRadius: 12,
    alignItems: 'center',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3,
  },
  buttonText: {
    color: '#FFFFFF',
    fontSize: 16,
    fontWeight: '600',
  },
});
```

### Tela: Confirma√ß√£o (Etapa 2)
```typescript
// screens/RecipeCompletionConfirmation.tsx

import React, { useEffect } from 'react';
import { View, Text, StyleSheet } from 'react-native';
import { useNavigation } from '@react-navigation/native';
import LottieView from 'lottie-react-native'; // Ou biblioteca de anima√ß√£o preferida

interface RecipeCompletionConfirmationProps {
  recipeId: string;
  basePoints: number;
}

export const RecipeCompletionConfirmation: React.FC<RecipeCompletionConfirmationProps> = ({
  recipeId,
  basePoints = 5
}) => {
  const navigation = useNavigation();

  useEffect(() => {
    // Auto-avan√ßar ap√≥s 2s
    const timer = setTimeout(() => {
      navigation.navigate('RecipeEngagement', { recipeId });
    }, 2000);

    return () => clearTimeout(timer);
  }, []);

  return (
    <View style={styles.container}>
      <LottieView
        source={require('@/assets/animations/success.json')}
        autoPlay
        loop={false}
        style={styles.animation}
      />
      
      <Text style={styles.title}>üéâ Receita conclu√≠da!</Text>
      <Text style={styles.subtitle}>Voc√™ ganhou {basePoints} pontos</Text>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#FFFFFF',
    padding: 24,
  },
  animation: {
    width: 200,
    height: 200,
  },
  title: {
    fontSize: 24,
    fontWeight: '700',
    color: '#1F2937',
    marginTop: 24,
    textAlign: 'center',
  },
  subtitle: {
    fontSize: 16,
    color: '#6B7280',
    marginTop: 8,
    textAlign: 'center',
  },
});
```

### Tela: Engajamento (Etapa 3)
```typescript
// screens/RecipeEngagement.tsx

import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  TextInput,
  TouchableOpacity,
  StyleSheet,
  ScrollView,
  ActivityIndicator,
} from 'react-native';
import { StarRating } from '@/components/StarRating';
import { PhotoPicker } from '@/components/PhotoPicker';
import { ProgressBar } from '@/components/ProgressBar';
import { updateEngagement, getEngagementProgress } from '@/services/recipe-completion.service';
import { EngagementProgress } from '@/types/recipe-completion';

interface RecipeEngagementProps {
  completionId: string;
  recipeId: string;
}

export const RecipeEngagement: React.FC<RecipeEngagementProps> = ({
  completionId,
  recipeId
}) => {
  const [rating, setRating] = useState<number>(5); // Pr√©-selecionado
  const [photo, setPhoto] = useState<string | null>(null);
  const [comment, setComment] = useState<string>('');
  const [progress, setProgress] = useState<EngagementProgress>({
    pointsEarned: 0,
    maxPoints: 30,
    breakdown: {
      rating: { completed: false, points: 10 },
      photo: { completed: false, points: 10 },
      comment: { completed: false, points: 10 },
    }
  });
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    loadProgress();
  }, []);

  const loadProgress = async () => {
    try {
      const data = await getEngagementProgress(completionId);
      setProgress(data);
    } catch (error) {
      console.error('Erro ao carregar progresso:', error);
    }
  };

  const handleRatingChange = async (newRating: number) => {
    setRating(newRating);
    if (!progress.breakdown.rating.completed) {
      await saveEngagement({ rating: newRating });
    }
  };

  const handlePhotoSelect = async (uri: string) => {
    setPhoto(uri);
    if (!progress.breakdown.photo.completed) {
      await saveEngagement({ photoUri: uri });
    }
  };

  const handleCommentChange = async (text: string) => {
    setComment(text);
    if (text.length >= 20 && !progress.breakdown.comment.completed) {
      await saveEngagement({ comment: text });
    }
  };

  const saveEngagement = async (data: Partial<EngagementData>) => {
    try {
      const pointsAdded = await updateEngagement(completionId, userId, data);
      if (pointsAdded > 0) {
        await loadProgress(); // Atualizar UI
      }
    } catch (error) {
      console.error('Erro ao salvar engajamento:', error);
    }
  };

  const handleComplete = async () => {
    setLoading(true);
    try {
      // Salvar dados finais pendentes
      await saveEngagement({ rating, photoUri: photo, comment });
      // Navegar para home/feed
      navigation.navigate('Home');
    } catch (error) {
      console.error('Erro ao finalizar:', error);
    } finally {
      setLoading(false);
    }
  };

  const getCtaLabel = () => {
    if (progress.pointsEarned === 0) return 'Concluir';
    return `Concluir (+${progress.pointsEarned} pontos)`;
  };

  return (
    <View style={styles.container}>
      <ScrollView style={styles.scrollView}>
        {/* HEADER */}
        <View style={styles.header}>
          <Text style={styles.title}>üíé Quer ganhar mais pontos?</Text>
          <Text style={styles.subtitle}>Leva menos de 1 minuto</Text>
          
          <ProgressBar
            current={progress.pointsEarned}
            max={progress.maxPoints}
            style={styles.progressBar}
          />
        </View>

        {/* SE√á√ÉO 1: AVALIA√á√ÉO */}
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>O que achou da receita?</Text>
          <StarRating
            rating={rating}
            onRatingChange={handleRatingChange}
            size={40}
          />
          {!progress.breakdown.rating.completed && (
            <Text style={styles.pointsBadge}>üíé +10 pontos</Text>
          )}
        </View>

        {/* SE√á√ÉO 2: FOTO */}
        <TouchableOpacity 
          style={styles.section}
          onPress={() => {/* Expandir se√ß√£o */}}
        >
          <View style={styles.sectionHeader}>
            <Text style={styles.sectionTitle}>üì∑ Adicionar foto</Text>
            {!progress.breakdown.photo.completed && (
              <Text style={styles.pointsBadge}>üíé +10 pontos</Text>
            )}
          </View>
          <Text style={styles.sectionSubtitle}>Mostre como ficou!</Text>
          
          <PhotoPicker
            onPhotoSelect={handlePhotoSelect}
            currentPhoto={photo}
          />
        </TouchableOpacity>

        {/* SE√á√ÉO 3: COMENT√ÅRIO */}
        <View style={styles.section}>
          <View style={styles.sectionHeader}>
            <Text style={styles.sectionTitle}>Coment√°rio</Text>
            {!progress.breakdown.comment.completed && (
              <Text style={styles.pointsBadge}>üíé +10 pontos</Text>
            )}
          </View>
          
          <TextInput
            style={styles.textInput}
            placeholder="Alguma dica, modifica√ß√£o ou resultado?"
            multiline
            numberOfLines={4}
            value={comment}
            onChangeText={handleCommentChange}
            maxLength={500}
          />
          
          <Text style={styles.characterCounter}>
            {comment.length}/20 caracteres
          </Text>
        </View>
      </ScrollView>

      {/* CTA FIXO */}
      <TouchableOpacity
        style={styles.ctaButton}
        onPress={handleComplete}
        disabled={loading}
      >
        {loading ? (
          <ActivityIndicator color="#FFFFFF" />
        ) : (
          <Text style={styles.ctaText}>{getCtaLabel()}</Text>
        )}
      </TouchableOpacity>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#F9FAFB',
  },
  scrollView: {
    flex: 1,
  },
  header: {
    padding: 24,
    backgroundColor: '#FFFFFF',
    borderBottomWidth: 1,
    borderBottomColor: '#E5E7EB',
  },
  title: {
    fontSize: 20,
    fontWeight: '700',
    color: '#1F2937',
  },
  subtitle: {
    fontSize: 14,
    color: '#6B7280',
    marginTop: 4,
  },
  progressBar: {
    marginTop: 16,
  },
  section: {
    backgroundColor: '#FFFFFF',
    padding: 16,
    marginTop: 8,
    borderRadius: 12,
    marginHorizontal: 16,
  },
  sectionHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  sectionTitle: {
    fontSize: 16,
    fontWeight: '600',
    color: '#1F2937',
  },
  sectionSubtitle: {
    fontSize: 14,
    color: '#6B7280',
    marginTop: 4,
  },
  pointsBadge: {
    fontSize: 12,
    color: '#D946EF',
    fontWeight: '600',
  },
  textInput: {
    borderWidth: 1,
    borderColor: '#D1D5DB',
    borderRadius: 8,
    padding: 12,
    marginTop: 8,
    fontSize: 14,
    minHeight: 100,
    textAlignVertical: 'top',
  },
  characterCounter: {
    fontSize: 12,
    color: '#9CA3AF',
    marginTop: 4,
    textAlign: 'right',
  },
  ctaButton: {
    backgroundColor: '#D946EF',
    margin: 16,
    padding: 16,
    borderRadius: 12,
    alignItems: 'center',
  },
  ctaText: {
    color: '#FFFFFF',
    fontSize: 16,
    fontWeight: '600',
  },
});
```

---

## COMPONENTES AUXILIARES

### ProgressBar Component
```typescript
// components/ProgressBar.tsx

import React from 'react';
import { View, Text, StyleSheet } from 'react-native';

interface ProgressBarProps {
  current: number;
  max: number;
  style?: any;
}

export const ProgressBar: React.FC<ProgressBarProps> = ({
  current,
  max,
  style
}) => {
  const percentage = (current / max) * 100;
  const filledBlocks = Math.floor((current / max) * 5);

  return (
    <View style={[styles.container, style]}>
      <View style={styles.blocksContainer}>
        {[...Array(5)].map((_, index) => (
          <View
            key={index}
            style={[
              styles.block,
              index < filledBlocks && styles.blockFilled
            ]}
          />
        ))}
      </View>
      <Text style={styles.text}>
        {current} / {max} pontos
      </Text>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    alignItems: 'center',
  },
  blocksContainer: {
    flexDirection: 'row',
    gap: 4,
    marginBottom: 8,
  },
  block: {
    width: 40,
    height: 8,
    backgroundColor: '#E5E7EB',
    borderRadius: 4,
  },
  blockFilled: {
    backgroundColor: '#D946EF',
  },
  text: {
    fontSize: 14,
    color: '#6B7280',
    fontWeight: '500',
  },
});
```

### StarRating Component
```typescript
// components/StarRating.tsx

import React from 'react';
import { View, TouchableOpacity, StyleSheet } from 'react-native';
import Icon from 'react-native-vector-icons/MaterialIcons';

interface StarRatingProps {
  rating: number;
  onRatingChange: (rating: number) => void;
  size?: number;
}

export const StarRating: React.FC<StarRatingProps> = ({
  rating,
  onRatingChange,
  size = 32
}) => {
  return (
    <View style={styles.container}>
      {[1, 2, 3, 4, 5].map((star) => (
        <TouchableOpacity
          key={star}
          onPress={() => onRatingChange(star)}
          activeOpacity={0.7}
        >
          <Icon
            name={star <= rating ? 'star' : 'star-border'}
            size={size}
            color={star <= rating ? '#FBBF24' : '#D1D5DB'}
          />
        </TouchableOpacity>
      ))}
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flexDirection: 'row',
    gap: 8,
    marginVertical: 12,
  },
});
```

### PhotoPicker Component
```typescript
// components/PhotoPicker.tsx

import React from 'react';
import { View, TouchableOpacity, Image, Text, StyleSheet } from 'react-native';
import * as ImagePicker from 'expo-image-picker';
import Icon from 'react-native-vector-icons/MaterialIcons';

interface PhotoPickerProps {
  onPhotoSelect: (uri: string) => void;
  currentPhoto: string | null;
}

export const PhotoPicker: React.FC<PhotoPickerProps> = ({
  onPhotoSelect,
  currentPhoto
}) => {
  const pickImage = async () => {
    const { status } = await ImagePicker.requestMediaLibraryPermissionsAsync();
    
    if (status !== 'granted') {
      alert('Precisamos de permiss√£o para acessar suas fotos');
      return;
    }

    const result = await ImagePicker.launchImageLibraryAsync({
      mediaTypes: ImagePicker.MediaTypeOptions.Images,
      allowsEditing: true,
      aspect: [4, 3],
      quality: 0.8,
    });

    if (!result.canceled) {
      onPhotoSelect(result.assets[0].uri);
    }
  };

  return (
    <View style={styles.container}>
      {currentPhoto ? (
        <View style={styles.photoContainer}>
          <Image source={{ uri: currentPhoto }} style={styles.photo} />
          <TouchableOpacity
            style={styles.changeButton}
            onPress={pickImage}
          >
            <Text style={styles.changeButtonText}>Alterar foto</Text>
          </TouchableOpacity>
        </View>
      ) : (
        <TouchableOpacity style={styles.uploadButton} onPress={pickImage}>
          <Icon name="add-a-photo" size={32} color="#9CA3AF" />
          <Text style={styles.uploadText}>Adicionar foto</Text>
        </TouchableOpacity>
      )}
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    marginTop: 12,
  },
  photoContainer: {
    alignItems: 'center',
  },
  photo: {
    width: '100%',
    height: 200,
    borderRadius: 12,
  },
  changeButton: {
    marginTop: 8,
    paddingVertical: 8,
    paddingHorizontal: 16,
    backgroundColor: '#F3F4F6',
    borderRadius: 8,
  },
  changeButtonText: {
    fontSize: 14,
    color: '#6B7280',
    fontWeight: '500',
  },
  uploadButton: {
    borderWidth: 2,
    borderColor: '#E5E7EB',
    borderStyle: 'dashed',
    borderRadius: 12,
    padding: 32,
    alignItems: 'center',
    justifyContent: 'center',
  },
  uploadText: {
    marginTop: 8,
    fontSize: 14,
    color: '#9CA3AF',
  },
});
```

---

## FUN√á√ïES RPC DO SUPABASE

### RPC: Adicionar Pontos ao Usu√°rio
```sql
-- functions/add_user_points.sql

CREATE OR REPLACE FUNCTION add_user_points(
  user_id UUID,
  points INTEGER,
  source TEXT,
  reference_id UUID
)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- Adicionar pontos ao saldo do usu√°rio
  UPDATE users
  SET 
    total_points = COALESCE(total_points, 0) + points,
    updated_at = NOW()
  WHERE id = user_id;

  -- Registrar transa√ß√£o de pontos
  INSERT INTO points_transactions (
    user_id,
    points,
    source,
    reference_id,
    created_at
  ) VALUES (
    user_id,
    points,
    source,
    reference_id,
    NOW()
  );
END;
$$;
```

### Tabela de Transa√ß√µes de Pontos
```sql
CREATE TABLE points_transactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) NOT NULL,
  points INTEGER NOT NULL,
  source TEXT NOT NULL,
  reference_id UUID,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_points_transactions_user ON points_transactions(user_id);
CREATE INDEX idx_points_transactions_source ON points_transactions(source);
```

---

## DIRETRIZES DE COPY

### ‚ùå EVITAR (Tom Burocr√°tico)
- "Ganhe at√©..."
- "Opcional"
- "Mais pontos dispon√≠veis"
- "Complete para..."
- "Maximize seus pontos"

### ‚úÖ USAR (Tom Convidativo)
- "Leva menos de 1 minuto"
- "Quer compartilhar sua experi√™ncia?"
- "Ajude a comunidade"
- "Mostre como ficou!"
- "O que achou?"

**PRINC√çPIO:** Gamifica√ß√£o como consequ√™ncia natural, n√£o como transa√ß√£o.

---

## M√âTRICAS DE SUCESSO

### KPIs Prim√°rios
```typescript
// analytics/recipe-completion-metrics.ts

export interface CompletionMetrics {
  // Taxa de conclus√£o
  totalRecipesViewed: number;
  totalRecipesCompleted: number;
  completionRate: number; // %
  
  // Engajamento na Etapa 3
  totalEngagementScreenViews: number;
  totalWithRating: number;
  totalWithPhoto: number;
  totalWithComment: number;
  totalFullEngagement: number; // Todos os 3
  
  // Distribui√ß√£o de pontos
  pointsDistribution: {
    points5: number;  // S√≥ conclus√£o
    points15: number; // Conclus√£o + 1 item
    points25: number; // Conclus√£o + 2 itens
    points35: number; // Conclus√£o + todos
  };
  
  // Tempo m√©dio
  avgTimeOnEngagementScreen: number; // segundos
  
  // Taxa de abandono
  abandonmentRate: {
    duringRecipe: number;    // %
    onConfirmation: number;  // %
    onEngagement: number;    // %
  };
}
```

### Queries de An√°lise
```sql
-- M√©trica: Taxa de conclus√£o geral
SELECT 
  COUNT(DISTINCT recipe_id) as recipes_viewed,
  COUNT(DISTINCT CASE WHEN completed_at IS NOT NULL THEN recipe_id END) as recipes_completed,
  (COUNT(DISTINCT CASE WHEN completed_at IS NOT NULL THEN recipe_id END)::FLOAT / 
   COUNT(DISTINCT recipe_id) * 100) as completion_rate
FROM recipe_views
WHERE created_at >= NOW() - INTERVAL '7 days';

-- M√©trica: Distribui√ß√£o de pontos
SELECT 
  total_points,
  COUNT(*) as count,
  (COUNT(*)::FLOAT / SUM(COUNT(*)) OVER () * 100) as percentage
FROM recipe_completions
WHERE created_at >= NOW() - INTERVAL '7 days'
GROUP BY total_points
ORDER BY total_points;

-- M√©trica: Taxa de engajamento completo
SELECT 
  COUNT(*) FILTER (WHERE rating IS NOT NULL) as with_rating,
  COUNT(*) FILTER (WHERE photo_url IS NOT NULL) as with_photo,
  COUNT(*) FILTER (WHERE comment IS NOT NULL) as with_comment,
  COUNT(*) FILTER (WHERE 
    rating IS NOT NULL AND 
    photo_url IS NOT NULL AND 
    comment IS NOT NULL
  ) as full_engagement,
  COUNT(*) as total_completions
FROM recipe_completions
WHERE created_at >= NOW() - INTERVAL '7 days';
```

---

## HIP√ìTESES A VALIDAR

### Hip√≥tese 1: Separa√ß√£o de Fluxos
**H1:** Separar conclus√£o de engajamento aumentar√° taxa de conclus√£o total em 15%+

**M√©trica:** 
```
baseline_completion_rate = (conclus√µes / visualiza√ß√µes) antes
new_completion_rate = (conclus√µes / visualiza√ß√µes) depois
improvement = ((new - baseline) / baseline) * 100
```

### Hip√≥tese 2: Pr√©-sele√ß√£o de 5 Estrelas
**H2:** Pr√©-selecionar 5‚òÖ n√£o reduzir√° qualidade m√©dia das avalia√ß√µes

**M√©trica:**
```
baseline_avg_rating = AVG(rating) com sistema atual
new_avg_rating = AVG(rating) com 5‚òÖ pr√©-selecionado
difference = new_avg_rating - baseline_avg_rating

Sucesso se: difference >= -0.3
```

### Hip√≥tese 3: Progresso Visual
**H3:** Barra de progresso visual aumentar√° taxa de engajamento completo em 20%+

**M√©trica:**
```
full_engagement_rate = (
  conclus√µes com rating + foto + coment√°rio
) / total de conclus√µes

Comparar: vers√£o A (sem barra) vs vers√£o B (com barra)
```

### Hip√≥tese 4: CTA Din√¢mico
**H4:** CTA com pontos din√¢micos motivar√° preenchimento de mais campos

**M√©trica:**
```
avg_fields_completed = AVG(
  (rating IS NOT NULL)::INT +
  (photo_url IS NOT NULL)::INT +
  (comment IS NOT NULL)::INT
)

Comparar antes/depois
```

---

## FASES DE IMPLEMENTA√á√ÉO

### FASE 1: Backend e Dados (Semana 1)
```
‚ñ° Criar tabela recipe_completions
‚ñ° Criar tabela points_transactions
‚ñ° Implementar fun√ß√£o add_user_points
‚ñ° Implementar service completeRecipe()
‚ñ° Implementar service updateEngagement()
‚ñ° Implementar service getEngagementProgress()
‚ñ° Criar √≠ndices de performance
‚ñ° Testes unit√°rios de regras de pontua√ß√£o
‚ñ° Testes de integridade de transa√ß√µes
```

### FASE 2: UI - Fluxo Base (Semana 2)
```
‚ñ° Componente RecipeCompletionButton
‚ñ° Tela RecipeCompletionConfirmation
‚ñ° Anima√ß√£o de celebra√ß√£o
‚ñ° Navega√ß√£o entre telas
‚ñ° Integra√ß√£o com backend (conclus√£o b√°sica)
‚ñ° Testes de fluxo completo
‚ñ° Ajustes de UX baseados em testes internos
```

### FASE 3: UI - Engajamento (Semanas 3-4)
```
‚ñ° Tela RecipeEngagement (estrutura)
‚ñ° Componente StarRating
‚ñ° Componente PhotoPicker
‚ñ° Componente ProgressBar
‚ñ° Input de coment√°rio com valida√ß√£o
‚ñ° L√≥gica de auto-save incremental
‚ñ° CTA din√¢mico
‚ñ° Testes de todos os componentes
‚ñ° Testes de fluxo end-to-end
```

### FASE 4: Polimento e Testes (Semana 5)
```
‚ñ° Ajustes de copy final
‚ñ° Refinamento de anima√ß√µes
‚ñ° Otimiza√ß√£o de performance
‚ñ° Testes de acessibilidade
‚ñ° Testes em dispositivos reais
‚ñ° Setup de analytics
‚ñ° Beta testing com usu√°rios selecionados
‚ñ° Ajustes baseados em feedback
```

### FASE 5: Deploy e Monitoramento (Semana 6)
```
‚ñ° Deploy gradual (10% ‚Üí 50% ‚Üí 100%)
‚ñ° Monitoramento de m√©tricas em tempo real
‚ñ° Compara√ß√£o A/B com fluxo antigo
‚ñ° Coleta de feedback qualitativo
‚ñ° Ajustes r√°pidos se necess√°rio
‚ñ° Documenta√ß√£o final
```

---

## CONSIDERA√á√ïES T√âCNICAS IMPORTANTES

### Performance
- Upload de fotos deve ser ass√≠ncrono (n√£o bloquear UI)
- Cache de progresso local para evitar m√∫ltiplas queries
- Debounce no input de coment√°rio (evitar saves excessivos)
- Otimizar queries com √≠ndices apropriados

### Seguran√ßa
- Validar pontos no backend (nunca confiar no frontend)
- Prevenir duplicatas com UNIQUE constraint
- Rate limiting em uploads de fotos
- Sanitiza√ß√£o de coment√°rios

### Acessibilidade
- Labels adequados em todos os inputs
- Suporte a screen readers
- Contraste de cores WCAG AA
- Tamanho de toque m√≠nimo 44x44pt

### Edge Cases
- Perda de conex√£o durante upload
- M√∫ltiplos dispositivos do mesmo usu√°rio
- Receitas j√° conclu√≠das (n√£o permitir re-conclus√£o)
- Fotos muito grandes (compress√£o autom√°tica)
- Coment√°rios com caracteres especiais

---

## ROLLBACK PLAN

Se m√©tricas indicarem problema:

1. **Crit√©rios de rollback:**
   - Completion rate cai > 10%
   - Crash rate aumenta > 2%
   - Feedback negativo > 30% dos usu√°rios

2. **Processo:**
   - Reverter para fluxo anterior via feature flag
   - Manter dados coletados (n√£o deletar)
   - Analisar logs de erro
   - Ajustar e re-testar

3. **Comunica√ß√£o:**
   - Notificar time de produto
   - Documentar problemas encontrados
   - Criar plano de corre√ß√£o

---

## PR√ìXIMOS PASSOS AP√ìS IMPLEMENTA√á√ÉO

1. **Itera√ß√£o 1:** Sistema de badges por conquistas
2. **Itera√ß√£o 2:** Feed social de receitas conclu√≠das
3. **Itera√ß√£o 3:** Gamifica√ß√£o de sequ√™ncias (streaks)
4. **Itera√ß√£o 4:** Recompensas por n√≠veis de pontua√ß√£o

---

FIM DO BRIEFING